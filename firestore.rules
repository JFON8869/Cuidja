/**
 * Core Philosophy: This ruleset implements a robust security model for the "Mercado Local Cuidja"
 * platform. It enforces strict user ownership for private data while enabling a public marketplace.
 * The core principle is that users have complete control over their own information and the
 * content they create, but limited or no access to the data of others.
 *
 * Data Structure: The data is organized into two main categories:
 * 1. User-Scoped Data: Nested under `/users/{userId}`, this includes private user profiles and
 *    personal order history. Access to these paths is strictly limited to the authenticated owner.
 * 2. Top-Level Collections: Collections like `/products` and `/orders` serve distinct purposes.
 *    `/products` is a public, read-only collection for all users to browse, with write
 *    permissions restricted to the product's seller. `/orders` and its subcollections are
 *    secured to the customer who created them.
 *
 * Key Security Decisions:
 * - Default Deny: All paths are closed by default. Access is only granted through explicit `allow` rules.
 * - Strict Ownership: A user can only access documents within their own `/users/{userId}` path.
 * - Public Product Discovery: The top-level `/products` collection is publicly readable to allow
 *   all users, including unauthenticated ones, to browse the marketplace.
 * - Seller-Controlled Products: Only the original seller of a product can update or delete it,
 *   enforced via a denormalized `sellerId` field on each product document.
 * - Private Orders: A user can only view their own orders. Access to `/orders/{orderId}` and its
 *   subcollections is controlled by a denormalized `customerId` field on the order document.
 * - No User Listing: It is not possible to list all documents in the `/users` collection,
 *   protecting user privacy.
 *
 * Denormalization for Authorization: To ensure fast and secure access control, authorization
 * data is denormalized. The `/products` collection contains a `sellerId` and the `/orders`
 * collection contains a `customerId`. This avoids slow and costly `get()` calls in rules,
 * making the security model more performant and scalable.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to improve readability and reuse of logic.
    function isSignedIn() {
      return request.auth != null;
    }

    // Checks if the requesting user is the owner based on a UID.
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Checks for ownership on an existing document. Used for update/delete.
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    // Checks if the requesting user is the owner of a document via a denormalized field.
    function isDocumentOwner(doc) {
      return isSignedIn() && resource != null && request.auth.uid == doc.customerId;
    }

    // Checks if the requesting user is the seller of a product/service via a denormalized field.
    function isResourceSeller(doc) {
      return isSignedIn() && resource != null && request.auth.uid == doc.sellerId;
    }
    
    // Validates that the customerId on a new order matches the creator's UID.
    function isCreatingOwnOrder() {
        return isSignedIn() && request.resource.data.customerId == request.auth.uid;
    }

    // Validates that the sellerId on a new resource (product/service) matches the creator's UID.
    function isCreatingOwnResource() {
        return isSignedIn() && request.resource.data.sellerId == request.auth.uid;
    }
    
    // Checks if the user associated with a parent order document is the requesting user.
    // This is used to secure access to subcollections like orderItems and payments.
    function isOrderCustomer(orderId) {
      let order = get(/databases/$(database)/documents/orders/$(orderId));
      return isSignedIn() && order.data.customerId == request.auth.uid;
    }

    /**
     * @description Rules for the user's private profile document.
     * @path /users/{userId}
     * @allow (create) A new user signing up: `auth.uid == userId`.
     * @allow (get, update) An existing user accessing their own profile: `auth.uid == userId`.
     * @deny (get) A user trying to read another user's profile.
     * @deny (list) Listing all users in the database is forbidden.
     * @principle Restricts access to a user's own data tree (Self-Creation & Ownership).
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Prevent listing all users
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for a seller's public store information.
     * @path /stores/{storeId}
     * @allow (get, list) Any user can read public store data.
     * @allow (create, update) Only the store owner can create or update their store details.
     * @principle Public Read with Owner-Only Writes.
     */
    match /stores/{storeId} {
        allow get, list: if true;
        allow create: if isOwner(request.resource.data.userId);
        allow update: if isOwner(resource.data.userId);
        allow delete: if isOwner(resource.data.userId);
    }
    
    /**
     * @description Rules for the public products collection, visible to everyone.
     * @path /products/{productId}
     * @allow (get, list) Any user, including unauthenticated ones, browsing the marketplace.
     * @allow (create) A signed-in user creating a product where they set themselves as the seller.
     * @allow (update, delete) The seller of the product modifying or deleting their own listing.
     * @deny (update) A user trying to change the price of another seller's product.
     * @principle Implements a Public Read with Owner-Only Writes pattern.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if isCreatingOwnResource();
      allow update: if isResourceSeller(resource.data);
      allow delete: if isResourceSeller(resource.data);
    }

    /**
     * @description Rules for the top-level orders collection.
     * @path /orders/{orderId}
     * @allow (create) A signed-in user creating an order for themselves.
     * @allow (get) The customer who placed the order viewing it.
     * @allow (list) A signed-in user querying for their own orders (requires client-side query constraint).
     * @deny (update, delete) Modifying or deleting placed orders is disallowed for safety.
     * @deny (get) A user trying to view an order placed by someone else.
     * @principle Secures data based on a denormalized `customerId` field.
     */
    match /orders/{orderId} {
      allow get: if isDocumentOwner(resource.data);
      // Allow signed-in users to query the collection.
      // The client MUST use a where('customerId', '==', auth.uid) clause to get results.
      allow list: if isSignedIn();
      allow create: if isCreatingOwnOrder();
      allow update, delete: if isDocumentOwner(resource.data) || isResourceSeller(get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data);
    }
  }
}
